name: Comprehensive Security Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight
  workflow_dispatch:
    inputs:
      full_scan:
        description: 'Run full security scan'
        required: false
        default: 'false'

permissions:
  security-events: write
  contents: read
  actions: read

env:
  PYTHON_VERSION: '3.11'

jobs:
  # =================================================================
  # Pre-commit Security Checks
  # =================================================================
  pre-commit-security:
    name: Pre-commit Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pre-commit tools
        run: |
          pip install bandit pre-commit gitleaks

      - name: Run Gitleaks (Secrets Scanning)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Run Bandit (SAST)
        run: |
          bandit -r nethical/ -f json -o bandit-results.json --severity-level medium || true
          bandit -r nethical/ -f txt --severity-level medium || true
        continue-on-error: true

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        with:
          name: bandit-results
          path: bandit-results.json
        if: always()

  # =================================================================
  # Static Application Security Testing (SAST)
  # =================================================================
  sast:
    name: SAST Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/python
            p/security-audit
            p/owasp-top-ten
            p/cwe-top-25
        continue-on-error: true

  # =================================================================
  # Dependency Scanning
  # =================================================================
  dependency-scan:
    name: Dependency Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install safety pip-audit

      - name: Run Safety Check
        run: |
          pip install -r requirements.txt
          safety check --json > safety-results.json || true
        continue-on-error: true

      - name: Run pip-audit
        run: |
          pip-audit --format json --output pip-audit-results.json || true
        continue-on-error: true

      - name: Run Trivy (Dependency Scan)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-dependency-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Upload Trivy results to Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-dependency-results.sarif
        if: always()

      - name: Upload dependency scan results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results
          path: |
            safety-results.json
            pip-audit-results.json
            trivy-dependency-results.sarif
        if: always()

  # =================================================================
  # Container Security Scanning
  # =================================================================
  container-scan:
    name: Container Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        id: docker_build
        run: |
          docker build -t nethical:security-scan . || echo "build_failed=true" >> $GITHUB_OUTPUT

      - name: Run Trivy (Container Scan)
        if: steps.docker_build.outputs.build_failed != 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'nethical:security-scan'
          format: 'sarif'
          output: 'trivy-container-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Run Grype (Container Scan)
        if: steps.docker_build.outputs.build_failed != 'true'
        uses: anchore/scan-action@v4
        with:
          image: 'nethical:security-scan'
          fail-build: false
          output-format: sarif
          severity-cutoff: high
        continue-on-error: true

      - name: Upload container scan results
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-results
          path: |
            trivy-container-results.sarif
        if: always()

  # =================================================================
  # SBOM Generation
  # =================================================================
  sbom:
    name: SBOM Generation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          path: '.'
          format: 'spdx-json'
          output-file: 'sbom-spdx.json'

      - name: Generate CycloneDX SBOM
        uses: anchore/sbom-action@v0
        with:
          path: '.'
          format: 'cyclonedx-json'
          output-file: 'sbom-cyclonedx.json'

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom-spdx.json
            sbom-cyclonedx.json

  # =================================================================
  # Dynamic Application Security Testing (DAST)
  # =================================================================
  dast:
    name: DAST Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.full_scan == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Start application
        run: |
          python -m nethical.api &
          sleep 10
        continue-on-error: true

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:8000'
          allow_issue_writing: false
        continue-on-error: true

      - name: Upload ZAP results
        uses: actions/upload-artifact@v4
        with:
          name: zap-results
          path: |
            report_html.html
            report_json.json
        if: always()

  # =================================================================
  # Infrastructure as Code Security
  # =================================================================
  iac-security:
    name: IaC Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov (IaC Security)
        uses: bridgecrewio/checkov-action@master
        with:
          directory: deploy/
          soft_fail: true
          output_format: sarif
          output_file_path: checkov-results.sarif

      - name: Run KICS
        uses: checkmarx/kics-github-action@master
        with:
          path: deploy/
          output_path: kics-results/
          output_formats: 'sarif'
        continue-on-error: true

      - name: Upload IaC scan results
        uses: actions/upload-artifact@v4
        with:
          name: iac-security-results
          path: |
            checkov-results.sarif
            kics-results/
        if: always()

  # =================================================================
  # License Compliance
  # =================================================================
  license-scan:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pip-licenses

      - name: Generate license report
        run: |
          pip install -r requirements.txt
          pip-licenses --format=json --output-file=licenses.json
          pip-licenses --format=markdown --output-file=licenses.md
        continue-on-error: true

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            licenses.json
            licenses.md
        if: always()

  # =================================================================
  # Security Report Aggregation
  # =================================================================
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [pre-commit-security, sast, dependency-scan, container-scan, sbom, iac-security, license-scan]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Generate consolidated report
        run: |
          cat << 'EOF' > generate_report.py
          import json
          import os
          from datetime import datetime

          report = {
              "generated_at": datetime.utcnow().isoformat(),
              "repository": os.environ.get("GITHUB_REPOSITORY", "unknown"),
              "run_id": os.environ.get("GITHUB_RUN_ID", "unknown"),
              "sections": {}
          }

          # Check for various scan results
          sections = [
              ("bandit", "security-reports/bandit-results/bandit-results.json"),
              ("safety", "security-reports/dependency-scan-results/safety-results.json"),
              ("pip-audit", "security-reports/dependency-scan-results/pip-audit-results.json"),
              ("licenses", "security-reports/license-report/licenses.json"),
          ]

          for name, path in sections:
              if os.path.exists(path):
                  try:
                      with open(path) as f:
                          report["sections"][name] = json.load(f)
                  except:
                      report["sections"][name] = {"error": "Failed to parse"}
              else:
                  report["sections"][name] = {"status": "not_found"}

          with open("consolidated-security-report.json", "w") as f:
              json.dump(report, f, indent=2)

          print("Security report generated successfully")
          EOF

          python generate_report.py

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-security-report
          path: consolidated-security-report.json

      - name: Create summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-commit Security | ${{ needs.pre-commit-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST Analysis | ${{ needs.sast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Scan | ${{ needs.container-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.sbom.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IaC Security | ${{ needs.iac-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.license-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
