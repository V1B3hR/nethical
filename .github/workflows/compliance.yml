# Compliance Validation Workflow for Nethical
#
# This workflow validates compliance against regulatory frameworks:
# - GDPR (EU General Data Protection Regulation)
# - EU AI Act (Regulation 2024/1689)
# - CCPA (California Consumer Privacy Act)
# - ISO 27001 (Information Security)
# - NIST AI RMF (AI Risk Management Framework)
#
# Adheres to Fundamental Laws:
# - Law 15: Audit Compliance - Comprehensive compliance auditing
# - Law 10: Reasoning Transparency - Clear validation results

name: Compliance Validation

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'nethical/**'
      - 'policies/**'
      - 'config/**'
      - 'docs/compliance/**'
  pull_request:
    branches: [main, master, develop]
  schedule:
    # Run weekly compliance check on Sundays at midnight
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      framework:
        description: 'Framework to validate (all, gdpr, eu_ai_act, ccpa, iso_27001, nist_ai_rmf)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - gdpr
          - eu_ai_act
          - ccpa
          - iso_27001
          - nist_ai_rmf

env:
  PYTHON_VERSION: '3.11'

jobs:
  compliance-validation:
    name: Validate Compliance
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyyaml  # For config file parsing
          
      - name: Run Compliance Validation
        id: compliance
        run: |
          FRAMEWORK="${{ github.event.inputs.framework || 'all' }}"
          echo "Validating framework: $FRAMEWORK"
          
          # Create reports directory
          mkdir -p reports/compliance
          
          # Run compliance validator
          python scripts/compliance_validator.py "$FRAMEWORK" \
            --output reports/compliance/compliance_report.json \
            --verbose
          
          # Check exit code
          if [ $? -eq 0 ]; then
            echo "compliance_status=passed" >> $GITHUB_OUTPUT
          else
            echo "compliance_status=failed" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate Compliance Summary
        if: always()
        run: |
          if [ -f "reports/compliance/compliance_report.json" ]; then
            echo "## Compliance Validation Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract key metrics using Python
            python -c "
import json
import sys

try:
    with open('reports/compliance/compliance_report.json') as f:
        report = json.load(f)
    
    print(f'**Report ID:** {report.get(\"report_id\", \"N/A\")}')
    print(f'**Generated:** {report.get(\"generated_at\", \"N/A\")}')
    print(f'**Overall Status:** {report.get(\"overall_status\", \"N/A\")}')
    print(f'**Compliance Score:** {report.get(\"compliance_score\", 0):.1f}%')
    print('')
    print('### Frameworks Validated')
    for fw in report.get('frameworks_validated', []):
        print(f'- {fw}')
    print('')
    
    # Count by status
    results = report.get('validation_results', [])
    compliant = sum(1 for r in results if r.get('status') == 'compliant')
    partial = sum(1 for r in results if r.get('status') == 'partial')
    non_compliant = sum(1 for r in results if r.get('status') == 'non_compliant')
    
    print('### Results Summary')
    print(f'- ✅ Compliant: {compliant}')
    print(f'- ⚠️ Partial: {partial}')
    print(f'- ❌ Non-Compliant: {non_compliant}')
    
    if report.get('recommendations'):
        print('')
        print('### Top Recommendations')
        for i, rec in enumerate(report['recommendations'][:5], 1):
            print(f'{i}. {rec}')
except Exception as e:
    print(f'Error reading report: {e}')
    sys.exit(0)
" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Upload Compliance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: reports/compliance/
          retention-days: 90
          
      - name: Check Compliance Status
        if: steps.compliance.outputs.compliance_status == 'failed'
        run: |
          echo "::warning::Compliance validation identified issues. Review the compliance report."
          # Don't fail the workflow for partial compliance
          # exit 1

  gdpr-specific:
    name: GDPR Deep Validation
    runs-on: ubuntu-latest
    needs: compliance-validation
    if: github.event_name == 'schedule' || github.event.inputs.framework == 'gdpr' || github.event.inputs.framework == 'all'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: GDPR Data Processing Check
        run: |
          echo "## GDPR Data Processing Inventory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for PII handling in code
          echo "### PII Processing Locations" >> $GITHUB_STEP_SUMMARY
          grep -r "pii\|personal_data\|email\|name\|address" --include="*.py" nethical/ 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "No explicit PII handling found" >> $GITHUB_STEP_SUMMARY
          
      - name: GDPR Rights Implementation Check
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Subject Rights Implementation" >> $GITHUB_STEP_SUMMARY
          
          # Check for data subject rights implementation
          for right in "access" "rectification" "erasure" "portability" "objection"; do
            if grep -r "$right" --include="*.py" nethical/ >/dev/null 2>&1; then
              echo "- ✅ Right to $right: Implemented" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ⚠️ Right to $right: Not explicitly found" >> $GITHUB_STEP_SUMMARY
            fi
          done

  eu-ai-act-specific:
    name: EU AI Act Deep Validation
    runs-on: ubuntu-latest
    needs: compliance-validation
    if: github.event_name == 'schedule' || github.event.inputs.framework == 'eu_ai_act' || github.event.inputs.framework == 'all'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: EU AI Act Article Checks
        run: |
          echo "## EU AI Act Compliance Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for Article implementations
          echo "### Article Implementation Status" >> $GITHUB_STEP_SUMMARY
          
          # Article 9: Risk Management
          if [ -f "nethical/core/risk_engine.py" ]; then
            echo "- ✅ Article 9 (Risk Management): nethical/core/risk_engine.py" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Article 9 (Risk Management): Not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Article 12: Logging
          if [ -f "nethical/security/audit_logging.py" ] || [ -f "nethical/core/audit_merkle.py" ]; then
            echo "- ✅ Article 12 (Record-keeping): Implemented" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Article 12 (Record-keeping): Not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Article 13: Transparency
          if [ -d "nethical/explainability" ]; then
            echo "- ✅ Article 13 (Transparency): nethical/explainability/" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Article 13 (Transparency): Not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Article 14: Human Oversight
          if [ -f "nethical/governance/human_review.py" ] || [ -f "nethical/core/human_feedback.py" ]; then
            echo "- ✅ Article 14 (Human Oversight): Implemented" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Article 14 (Human Oversight): Not found" >> $GITHUB_STEP_SUMMARY
          fi

  data-residency-check:
    name: Data Residency Validation
    runs-on: ubuntu-latest
    needs: compliance-validation
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Data Residency Configuration Check
        run: |
          echo "## Data Residency Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for data residency module
          if [ -f "nethical/compliance/data_residency.py" ]; then
            echo "✅ Data Residency Manager: Implemented" >> $GITHUB_STEP_SUMMARY
            
            # Extract regions from config
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Configured Regions" >> $GITHUB_STEP_SUMMARY
            grep -E "EU_|US_|AP_|GLOBAL" nethical/compliance/data_residency.py | head -10 >> $GITHUB_STEP_SUMMARY || true
          else
            echo "⚠️ Data Residency Manager: Not found" >> $GITHUB_STEP_SUMMARY
          fi
