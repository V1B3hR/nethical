name: CI - Lint, Test, Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install black flake8 mypy
      
      - name: Run Black
        run: black --check nethical/ tests/ examples/ || true
      
      - name: Run Flake8
        run: flake8 nethical/ tests/ examples/ --max-line-length=88 --extend-ignore=E203,W503 || true
      
      - name: Run Mypy
        run: mypy nethical/ --ignore-missing-imports || true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']  # ‚úÖ Remove '3.9'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Clear Python cache and bytecode
        run: |
          echo "üßπ Removing .pyc files and __pycache__ directories"
          find . -type f -name '*.pyc' -delete
          find . -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true
          echo "‚úÖ Cache cleared"
      
      - name: Verify source file content
        run: |
          echo "üìÑ Verifying semantic_primitives.py content"
          echo "File location: nethical/core/semantic_primitives.py"
          cat nethical/core/semantic_primitives.py | grep -A 25 "class SemanticPrimitive" || true
          echo ""
          echo "Checking for MODIFY_CODE definition:"
          grep -n "MODIFY_CODE" nethical/core/semantic_primitives.py || echo "‚ö†Ô∏è  MODIFY_CODE not found in source"
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: Force-reinstall package
        run: |
          echo "üîÑ Force-reinstalling nethical package"
          pip install . --force-reinstall --no-deps
          echo "‚úÖ Package reinstalled"
      
      - name: Verify Python environment
        run: |
          echo "üîç Python environment verification"
          echo "Python version: $(python --version)"
          echo "Python executable: $(which python)"
          echo ""
          echo "üì¶ Installed nethical location:"
          python -c "import nethical; print(nethical.__file__)" || echo "‚ö†Ô∏è  Failed to import nethical"
          echo ""
          echo "üìù sys.path:"
          python -c "import sys; import pprint; pprint.pprint(sys.path)"
          echo ""
          echo "üîé Verifying SemanticPrimitive members:"
          python -c "from nethical.core.semantic_primitives import SemanticPrimitive; print('Members:', list(SemanticPrimitive.__members__.keys())); print('Has MODIFY_CODE:', 'MODIFY_CODE' in SemanticPrimitive.__members__)" || echo "‚ö†Ô∏è  Failed to import SemanticPrimitive"
          echo ""
          echo "üìç semantic_primitives.py module location:"
          python -c "import nethical.core.semantic_primitives as sp; print(sp.__file__)" || echo "‚ö†Ô∏è  Failed to locate module"
      
      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=nethical --cov-report=xml --cov-report=html --cov-report=term
        continue-on-error: true
      
      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: |
            coverage.xml
            htmlcov/
        if: always()
      
      - name: Run adversarial tests
        run: |
          pytest tests/adversarial/ -v --tb=short
        continue-on-error: true

  build:
    name: Build Package
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install build tools
        run: |
          pip install --upgrade pip
          pip install build twine
      
      - name: Build package
        run: python -m build
      
      - name: Check package
        run: twine check dist/*
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-package
          path: dist/
      
      - name: Upload wheel for security scan
        uses: actions/upload-artifact@v4
        with:
          name: wheel-file
          path: dist/*.whl
