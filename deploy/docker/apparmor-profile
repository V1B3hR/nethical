# AppArmor Profile for Nethical Docker Container
# 
# This profile provides security hardening for Nethical running in Docker
# (non-Kubernetes deployments).
#
# Installation:
#   1. Copy this file to: /etc/apparmor.d/nethical-docker
#   2. Load profile: sudo apparmor_parser -r -W /etc/apparmor.d/nethical-docker
#   3. Verify: sudo aa-status | grep nethical
#
# Usage with Docker:
#   docker run --security-opt apparmor=nethical-docker nethical:latest
#
# For more information:
#   - AppArmor documentation: https://gitlab.com/apparmor/apparmor/-/wikis/home
#   - Docker AppArmor: https://docs.docker.com/engine/security/apparmor/

#include <tunables/global>

profile nethical-docker flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/python>
  
  # Network access - required for API server
  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,
  network inet tcp,
  network inet6 tcp,
  network unix stream,
  network unix dgram,
  
  # Allow binding to non-privileged ports (>1024)
  # For port 8000 (default Nethical API port)
  capability net_bind_service,
  
  # File system access - Application files (read-only)
  /app/** r,
  /app/nethical.py rix,
  
  # Python interpreter and libraries (read + execute)
  /usr/bin/python3* ix,
  /usr/local/bin/python3* ix,
  /usr/lib/python3*/** r,
  /usr/local/lib/python3*/** r,
  /lib/python3*/** r,
  
  # Required system libraries (read + map)
  /lib/** rm,
  /lib64/** rm,
  /usr/lib/** rm,
  /usr/lib64/** rm,
  /usr/local/lib/** rm,
  
  # Configuration files (read-only)
  /app/config/** r,
  /app/*.yaml r,
  /app/*.yml r,
  /app/*.json r,
  
  # Data directory (read/write)
  /data/** rw,
  /data/ rw,
  owner /data/** rw,
  
  # Temporary directory (read/write)
  /tmp/** rw,
  /tmp/ rw,
  owner /tmp/** rwk,
  
  # Process-specific temporary files
  owner /tmp/tmp* rw,
  
  # Allow reading /proc for process information
  /proc/ r,
  /proc/cpuinfo r,
  /proc/meminfo r,
  /proc/loadavg r,
  /proc/stat r,
  /proc/uptime r,
  /proc/sys/kernel/random/uuid r,
  /proc/sys/kernel/random/boot_id r,
  /proc/self/** r,
  /proc/sys/net/** r,
  
  # Allow reading /sys for system information
  /sys/devices/system/cpu/** r,
  /sys/devices/system/node/** r,
  
  # DNS resolution (required for network operations)
  /etc/resolv.conf r,
  /etc/hosts r,
  /etc/hostname r,
  /etc/nsswitch.conf r,
  /etc/gai.conf r,
  /run/systemd/resolve/stub-resolv.conf r,
  
  # SSL/TLS certificates (required for HTTPS)
  /etc/ssl/certs/** r,
  /etc/pki/tls/certs/** r,
  /usr/share/ca-certificates/** r,
  /etc/ssl/openssl.cnf r,
  
  # Timezone information
  /etc/localtime r,
  /usr/share/zoneinfo/** r,
  
  # User and group information
  /etc/passwd r,
  /etc/group r,
  
  # Python package information
  /home/nethical/.local/** r,
  /root/.local/** r,
  owner /home/nethical/.local/** rw,
  
  # Python cache directories
  owner /home/nethical/.cache/** rw,
  owner /root/.cache/** rw,
  
  # Allow Python to create bytecode cache
  owner /**/__pycache__/ rw,
  owner /**/__pycache__/** rw,
  owner /**/*.pyc rw,
  
  # Dev filesystems (limited access)
  /dev/null rw,
  /dev/zero r,
  /dev/random r,
  /dev/urandom r,
  /dev/tty rw,
  
  # Deny dangerous operations
  deny /sys/kernel/security/** rw,
  deny /sys/firmware/** rw,
  deny /proc/sys/kernel/core_pattern w,
  deny /proc/kcore r,
  deny /proc/kallsyms r,
  deny /boot/** r,
  deny /dev/mem rw,
  deny /dev/kmem rw,
  deny /dev/port rw,
  
  # Deny access to other containers/processes
  deny /proc/[0-9]*/mem rw,
  deny /proc/[0-9]*/fd/** rw,
  deny /proc/[0-9]*/environ r,
  deny /proc/[0-9]*/cmdline r,
  
  # Deny privileged operations
  deny capability sys_admin,
  deny capability sys_module,
  deny capability sys_rawio,
  deny capability sys_ptrace,
  deny capability sys_boot,
  deny capability mac_admin,
  deny capability mac_override,
  deny capability dac_read_search,
  
  # Allow minimal required capabilities
  capability setuid,
  capability setgid,
  capability chown,
  capability fowner,
  capability fsetid,
  capability dac_override,
  
  # Signal permissions
  signal receive peer=unconfined,
  signal receive peer=docker-default,
  signal send peer=nethical-docker,
  signal (receive) set=(kill,term,int,hup,quit),
  
  # Unix domain sockets (for local IPC)
  unix (bind, listen) type=stream,
  unix (bind, listen) type=dgram,
  unix (connect, send, receive) type=stream,
  unix (connect, send, receive) type=dgram,
  
  # Ptrace (deny by default for security)
  deny ptrace,
  
  # Mount operations (deny)
  deny mount,
  deny remount,
  deny umount,
  
  # Module loading (deny)
  deny /sys/module/** w,
  
  # Prevent modification of AppArmor profiles
  deny /sys/kernel/security/apparmor/** w,
  
  # Deny access to container runtime
  deny /var/run/docker.sock rw,
  deny /run/containerd/** rw,
  
  # Log access (append-only)
  /var/log/nethical/** w,
  /var/log/nethical/ w,
  owner /var/log/nethical/** rw,
  
  # Deny changes to sensitive system files
  deny /etc/passwd w,
  deny /etc/shadow rw,
  deny /etc/group w,
  deny /etc/sudoers** rw,
  
  # Container-specific paths
  deny /var/lib/docker/** rw,
  deny /var/lib/containerd/** rw,
}
