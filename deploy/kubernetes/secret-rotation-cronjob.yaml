---
# ServiceAccount for secret rotation
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-rotator
  namespace: nethical
  labels:
    app.kubernetes.io/name: nethical
    app.kubernetes.io/component: secret-rotation

---
# Role for secret rotation operations
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-rotator
  namespace: nethical
  labels:
    app.kubernetes.io/name: nethical
    app.kubernetes.io/component: secret-rotation
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets"]
  verbs: ["get", "list", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments/status", "statefulsets/status"]
  verbs: ["get"]
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets"]
  verbs: ["get", "list", "patch"]

---
# RoleBinding for secret rotation
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-rotator
  namespace: nethical
  labels:
    app.kubernetes.io/name: nethical
    app.kubernetes.io/component: secret-rotation
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: secret-rotator
subjects:
- kind: ServiceAccount
  name: secret-rotator
  namespace: nethical

---
# ConfigMap with rotation script
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-rotation-scripts
  namespace: nethical
  labels:
    app.kubernetes.io/name: nethical
    app.kubernetes.io/component: secret-rotation
data:
  rotate-secrets.sh: |
    #!/bin/bash
    set -euo pipefail
    
    echo "Starting secret rotation at $(date)"
    
    # Vault configuration
    VAULT_ADDR="${VAULT_ADDR:-https://vault.example.com}"
    VAULT_TOKEN="${VAULT_TOKEN}"
    
    # Function to generate secure random strings
    generate_password() {
      openssl rand -base64 32 | tr -d "=+/" | cut -c1-32
    }
    
    # Function to generate RSA key pair
    generate_rsa_keypair() {
      local private_key=$(openssl genrsa 4096 2>/dev/null | base64 -w0)
      local public_key=$(echo "$private_key" | base64 -d | openssl rsa -pubout 2>/dev/null | base64 -w0)
      echo "$private_key|$public_key"
    }
    
    # Function to rotate secret in Vault
    rotate_vault_secret() {
      local path=$1
      local data=$2
      
      echo "Rotating secret at $path"
      curl -X POST \
        -H "X-Vault-Token: $VAULT_TOKEN" \
        -d "$data" \
        "$VAULT_ADDR/v1/secret/data/$path"
    }
    
    # Rotate JWT signing keys
    echo "Rotating JWT signing keys..."
    keypair=$(generate_rsa_keypair)
    private_key=$(echo "$keypair" | cut -d'|' -f1)
    public_key=$(echo "$keypair" | cut -d'|' -f2)
    
    rotate_vault_secret "nethical/jwt" "{
      \"data\": {
        \"private_key\": \"$private_key\",
        \"public_key\": \"$public_key\",
        \"rotated_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
      }
    }"
    
    # Rotate database password
    echo "Rotating database password..."
    db_password=$(generate_password)
    rotate_vault_secret "nethical/database" "{
      \"data\": {
        \"username\": \"nethical\",
        \"password\": \"$db_password\",
        \"rotated_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
      }
    }"
    
    # Update database user password (using stdin to avoid password exposure)
    echo "$db_password" | PGPASSWORD="$OLD_DB_PASSWORD" psql -h postgresql.nethical.svc.cluster.local -U nethical -d nethical \
      -c "ALTER USER nethical WITH PASSWORD '$db_password';" || echo "Database password update failed, manual intervention required"
    
    # Rotate Redis password
    echo "Rotating Redis password..."
    redis_password=$(generate_password)
    rotate_vault_secret "nethical/redis" "{
      \"data\": {
        \"password\": \"$redis_password\",
        \"rotated_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
      }
    }"
    
    # Configure Redis with new password
    kubectl exec -n nethical redis-0 -- redis-cli CONFIG SET requirepass "$redis_password" || \
      echo "Redis password update failed, manual intervention required"
    
    # Rotate encryption keys
    echo "Rotating encryption keys..."
    data_encryption_key=$(openssl rand -base64 32)
    key_encryption_key=$(openssl rand -base64 32)
    rotate_vault_secret "nethical/encryption" "{
      \"data\": {
        \"data_encryption_key\": \"$data_encryption_key\",
        \"key_encryption_key\": \"$key_encryption_key\",
        \"rotated_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
      }
    }"
    
    # Force refresh of external secrets
    echo "Refreshing external secrets..."
    kubectl annotate externalsecret -n nethical --all \
      force-sync="$(date +%s)" --overwrite
    
    # Wait for secrets to be updated
    echo "Waiting for secrets to propagate..."
    sleep 30
    
    # Rolling restart of Nethical pods to pick up new secrets
    echo "Performing rolling restart of Nethical pods..."
    kubectl rollout restart statefulset/nethical -n nethical
    kubectl rollout status statefulset/nethical -n nethical --timeout=5m
    
    # Verify rotation success
    echo "Verifying secret rotation..."
    if kubectl get externalsecrets -n nethical -o json | jq -e '.items[] | select(.status.conditions[] | select(.type=="Ready" and .status=="False"))' > /dev/null; then
      echo "ERROR: Some external secrets failed to sync!"
      kubectl get externalsecrets -n nethical
      exit 1
    fi
    
    echo "Secret rotation completed successfully at $(date)"
    
    # Send notification
    if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
      curl -X POST "$SLACK_WEBHOOK_URL" \
        -H 'Content-Type: application/json' \
        -d "{\"text\":\"Nethical secrets rotated successfully at $(date)\"}"
    fi

  check-rotation-status.sh: |
    #!/bin/bash
    set -euo pipefail
    
    echo "Checking secret rotation status..."
    
    VAULT_ADDR="${VAULT_ADDR:-https://vault.example.com}"
    VAULT_TOKEN="${VAULT_TOKEN}"
    
    # Check rotation timestamps
    for secret_path in "nethical/jwt" "nethical/database" "nethical/redis" "nethical/encryption"; do
      echo "Checking $secret_path..."
      
      rotated_at=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN" \
        "$VAULT_ADDR/v1/secret/data/$secret_path" | \
        jq -r '.data.data.rotated_at // "never"')
      
      echo "  Last rotated: $rotated_at"
      
      if [ "$rotated_at" != "never" ]; then
        age_seconds=$(( $(date +%s) - $(date -d "$rotated_at" +%s) ))
        age_days=$(( age_seconds / 86400 ))
        
        echo "  Age: $age_days days"
        
        if [ $age_days -gt 90 ]; then
          echo "  WARNING: Secret is older than 90 days!"
        fi
      fi
    done

---
# CronJob for automatic secret rotation (every 30 days)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: rotate-secrets
  namespace: nethical
  labels:
    app.kubernetes.io/name: nethical
    app.kubernetes.io/component: secret-rotation
spec:
  schedule: "0 2 */30 * *"  # At 2 AM every 30 days
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        app: nethical
        job: secret-rotation
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: nethical
            job: secret-rotation
        spec:
          serviceAccountName: secret-rotator
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault
          containers:
          - name: rotate
            image: bitnami/kubectl:latest
            imagePullPolicy: IfNotPresent
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
              capabilities:
                drop:
                - ALL
            command:
            - /bin/bash
            - /scripts/rotate-secrets.sh
            env:
            - name: VAULT_ADDR
              value: "https://vault.example.com"
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vault-token
                  key: token
            - name: OLD_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nethical-database
                  key: password
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: nethical-integrations
                  key: slack-webhook
                  optional: true
            volumeMounts:
            - name: scripts
              mountPath: /scripts
              readOnly: true
            - name: tmp
              mountPath: /tmp
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "200m"
          volumes:
          - name: scripts
            configMap:
              name: secret-rotation-scripts
              defaultMode: 0755
          - name: tmp
            emptyDir: {}

---
# CronJob for rotation status monitoring (daily)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: check-secret-rotation
  namespace: nethical
  labels:
    app.kubernetes.io/name: nethical
    app.kubernetes.io/component: secret-rotation
spec:
  schedule: "0 9 * * *"  # Daily at 9 AM
  concurrencyPolicy: Allow
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        app: nethical
        job: secret-rotation-check
    spec:
      template:
        metadata:
          labels:
            app: nethical
            job: secret-rotation-check
        spec:
          serviceAccountName: secret-rotator
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault
          containers:
          - name: check
            image: bitnami/kubectl:latest
            imagePullPolicy: IfNotPresent
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
              capabilities:
                drop:
                - ALL
            command:
            - /bin/bash
            - /scripts/check-rotation-status.sh
            env:
            - name: VAULT_ADDR
              value: "https://vault.example.com"
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vault-token
                  key: token
            volumeMounts:
            - name: scripts
              mountPath: /scripts
              readOnly: true
            - name: tmp
              mountPath: /tmp
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "128Mi"
                cpu: "100m"
          volumes:
          - name: scripts
            configMap:
              name: secret-rotation-scripts
              defaultMode: 0755
          - name: tmp
            emptyDir: {}
