# Nethical HA PostgreSQL Cluster Deployment
# Uses PostgreSQL with TimescaleDB extension for time-series data
# Deploys with high availability using streaming replication

apiVersion: v1
kind: Namespace
metadata:
  name: nethical-db
  labels:
    app.kubernetes.io/name: nethical-db
    app.kubernetes.io/component: database

---
# Secret for PostgreSQL credentials
# PROVISIONING INSTRUCTIONS:
# This secret template defines required keys but does NOT contain actual values.
# Provision secrets before deploying using one of the following methods:
#
# Option 1 - kubectl create secret:
#   kubectl create secret generic postgres-credentials \
#     --namespace nethical-db \
#     --from-literal=POSTGRES_USER='<your-db-user>' \
#     --from-literal=POSTGRES_PASSWORD='<your-strong-password>' \
#     --from-literal=POSTGRES_DB='<your-db-name>' \
#     --from-literal=REPLICATION_USER='<your-replication-user>' \
#     --from-literal=REPLICATION_PASSWORD='<your-replication-password>' \
#     --from-literal=DATA_SOURCE_NAME='postgresql://<user>:<password>@localhost:5432/<db>?sslmode=disable'
#
# Option 2 - External Secrets Operator (recommended for production):
#   Configure ExternalSecret CRD to sync from:
#   - HashiCorp Vault
#   - AWS Secrets Manager
#   - Azure Key Vault
#   - Google Cloud Secret Manager
#   See: https://external-secrets.io/
apiVersion: v1
kind: Secret
metadata:
  name: postgres-credentials
  namespace: nethical-db
  annotations:
    kubernetes.io/description: "Template for PostgreSQL credentials - provision via kubectl or external secret manager"
type: Opaque
# Keys are defined but values must be provisioned externally
# Do not commit actual secret values to this file
# Required keys: POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB, REPLICATION_USER, REPLICATION_PASSWORD, DATA_SOURCE_NAME
data: {}

---
# ConfigMap for PostgreSQL configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: nethical-db
data:
  # Primary PostgreSQL configuration
  postgresql.conf: |
    # Connection Settings
    listen_addresses = '*'
    port = 5432
    max_connections = 200
    superuser_reserved_connections = 5
    
    # Memory Settings
    shared_buffers = 256MB
    effective_cache_size = 768MB
    maintenance_work_mem = 64MB
    work_mem = 4MB
    
    # WAL Settings for Replication
    wal_level = replica
    max_wal_senders = 10
    max_replication_slots = 10
    wal_keep_size = 1GB
    hot_standby = on
    hot_standby_feedback = on
    
    # Checkpoint Settings
    checkpoint_completion_target = 0.9
    max_wal_size = 2GB
    min_wal_size = 80MB
    
    # Logging
    logging_collector = on
    log_directory = '/var/log/postgresql'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_min_duration_statement = 1000
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    
    # TimescaleDB
    shared_preload_libraries = 'timescaledb'
    timescaledb.telemetry_level = 'off'
    
    # Performance
    random_page_cost = 1.1
    effective_io_concurrency = 200
    default_statistics_target = 100
    
    # Security
    ssl = on
    ssl_cert_file = '/etc/postgresql/certs/server.crt'
    ssl_key_file = '/etc/postgresql/certs/server.key'
    password_encryption = 'scram-sha-256'
    
  # Client authentication configuration
  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    
    # Local connections
    local   all             all                                     scram-sha-256
    
    # IPv4 local connections with SSL
    hostssl all             all             0.0.0.0/0               scram-sha-256
    
    # Replication connections
    hostssl replication     replicator      0.0.0.0/0               scram-sha-256
    
    # Allow health checks
    host    all             all             127.0.0.1/32            scram-sha-256
    
  # Initialization script
  init-db.sh: |
    #!/bin/bash
    set -e
    
    # Create nethical schema and extensions
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
        -- Create schema
        CREATE SCHEMA IF NOT EXISTS nethical;
        
        -- Enable extensions
        CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
        CREATE EXTENSION IF NOT EXISTS "timescaledb";
        CREATE EXTENSION IF NOT EXISTS "pg_trgm";
        
        -- Create application role
        DO \$\$
        BEGIN
            IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'nethical_app') THEN
                CREATE ROLE nethical_app WITH LOGIN PASSWORD 'app_password_change_me';
            END IF;
        END
        \$\$;
        
        -- Grant permissions
        GRANT USAGE ON SCHEMA nethical TO nethical_app;
        GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA nethical TO nethical_app;
        GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA nethical TO nethical_app;
        
        -- Set default privileges for future tables
        ALTER DEFAULT PRIVILEGES IN SCHEMA nethical 
            GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO nethical_app;
        ALTER DEFAULT PRIVILEGES IN SCHEMA nethical 
            GRANT USAGE, SELECT ON SEQUENCES TO nethical_app;
    EOSQL
    
    echo "Database initialization complete"

---
# Headless Service for StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: postgres-headless
  namespace: nethical-db
  labels:
    app: postgres
spec:
  ports:
    - port: 5432
      name: postgres
  clusterIP: None
  selector:
    app: postgres

---
# Primary PostgreSQL Service
apiVersion: v1
kind: Service
metadata:
  name: postgres-primary
  namespace: nethical-db
  labels:
    app: postgres
    role: primary
spec:
  ports:
    - port: 5432
      targetPort: 5432
      name: postgres
  selector:
    app: postgres
    role: primary
  type: ClusterIP

---
# Read-only Replica Service
apiVersion: v1
kind: Service
metadata:
  name: postgres-replica
  namespace: nethical-db
  labels:
    app: postgres
    role: replica
spec:
  ports:
    - port: 5432
      targetPort: 5432
      name: postgres
  selector:
    app: postgres
    role: replica
  type: ClusterIP

---
# PostgreSQL StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: nethical-db
  labels:
    app: postgres
spec:
  serviceName: postgres-headless
  replicas: 3  # 1 primary + 2 replicas
  podManagementPolicy: OrderedReady
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9187"
    spec:
      securityContext:
        fsGroup: 999
        runAsUser: 999
        runAsNonRoot: true
        
      initContainers:
        # Determine if this is primary or replica
        - name: init-role
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              # First pod is primary, others are replicas
              ORDINAL=${HOSTNAME##*-}
              if [ "$ORDINAL" = "0" ]; then
                echo "primary" > /var/run/postgresql/role
              else
                echo "replica" > /var/run/postgresql/role
              fi
          volumeMounts:
            - name: run
              mountPath: /var/run/postgresql
              
      containers:
        - name: postgres
          image: timescale/timescaledb:2.14.2-pg16
          imagePullPolicy: IfNotPresent
          
          ports:
            - containerPort: 5432
              name: postgres
              
          envFrom:
            - secretRef:
                name: postgres-credentials
                
          env:
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
                  
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
              
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
            - name: config
              mountPath: /etc/postgresql/conf.d
            - name: init-scripts
              mountPath: /docker-entrypoint-initdb.d
            - name: run
              mountPath: /var/run/postgresql
              
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - pg_isready -U $POSTGRES_USER -d $POSTGRES_DB
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
            
          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - pg_isready -U $POSTGRES_USER -d $POSTGRES_DB
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
            
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
                
        # PostgreSQL Exporter for Prometheus metrics
        - name: postgres-exporter
          image: prometheuscommunity/postgres-exporter:v0.15.0
          ports:
            - containerPort: 9187
              name: metrics
          env:
            - name: DATA_SOURCE_NAME
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: DATA_SOURCE_NAME
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
              
      volumes:
        - name: config
          configMap:
            name: postgres-config
            items:
              - key: postgresql.conf
                path: postgresql.conf
        - name: init-scripts
          configMap:
            name: postgres-config
            items:
              - key: init-db.sh
                path: init-db.sh
                mode: 0755
        - name: run
          emptyDir: {}
          
  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app: postgres
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 100Gi
        # Uncomment and set storage class for production
        # storageClassName: fast-ssd

---
# Pod Disruption Budget
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: postgres-pdb
  namespace: nethical-db
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: postgres

---
# Network Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-network-policy
  namespace: nethical-db
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from nethical namespace
    - from:
        - namespaceSelector:
            matchLabels:
              name: nethical
      ports:
        - port: 5432
          protocol: TCP
    # Allow from monitoring
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - port: 9187
          protocol: TCP
    # Allow replication between pods
    - from:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - port: 5432
          protocol: TCP
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - port: 53
          protocol: UDP
    # Allow replication between pods
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - port: 5432
          protocol: TCP

---
# ServiceMonitor for Prometheus
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-monitor
  namespace: nethical-db
  labels:
    app: postgres
spec:
  selector:
    matchLabels:
      app: postgres
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
